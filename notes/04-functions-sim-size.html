<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Charlotte Wickham" />


<title>Functions and simulation size</title>

<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>
<link href="libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="libs/highlightjs-9.12.0/highlight.js"></script>
<link href="libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="libs/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Functions and simulation size</h1>
<h4 class="author"><em>Charlotte Wickham</em></h4>
<h4 class="date"><em>Oct 2nd 2018</em></h4>

</div>

<div id="TOC">
<ul>
<li><a href="#from-last-time">From last time</a><ul>
<li><a href="#warm-upthe-challenge-from-last-time">Warm up…the challenge from last time</a></li>
</ul></li>
<li><a href="#homework">Homework</a></li>
<li><a href="#computation-in-statistics-task">Computation in Statistics task</a><ul>
<li><a href="#my-take">My take</a></li>
<li><a href="#project">Project</a></li>
</ul></li>
<li><a href="#simulation">Simulation</a><ul>
<li><a href="#one-pretty-flexible-approach">One pretty flexible approach</a></li>
<li><a href="#the-challenge-from-last-time">The challenge from last time</a></li>
<li><a href="#ways-things-get-more-complicated">Ways things get more complicated</a></li>
<li><a href="#functions---your-turn">Functions - Your Turn</a></li>
<li><a href="#exponential-inverse-transform">Exponential Inverse Transform</a></li>
<li><a href="#inverse-transform">Inverse Transform</a></li>
<li><a href="#takeaways">Takeaways</a></li>
</ul></li>
<li><a href="#how-many-simulations-do-we-need">How many simulations do we need?</a><ul>
<li><a href="#how-big-a-simulation-should-we-run">How big a simulation should we run?</a></li>
<li><a href="#clt">CLT</a></li>
<li><a href="#a-special-case-binary-outcomes">A special case: binary outcomes</a></li>
<li><a href="#how-big-a-simulation">How big a simulation?</a></li>
<li><a href="#next-time">Next time</a></li>
</ul></li>
</ul>
</div>

<pre class="r"><code>knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
set.seed(181818)</code></pre>
<div id="from-last-time" class="section level1">
<h1>From last time</h1>
<div id="warm-upthe-challenge-from-last-time" class="section level2">
<h2>Warm up…the challenge from last time</h2>
<p>A random sequence of H’s and T’s is generated by tossing a fair coin <span class="math inline">\(n = 20\)</span> times. What’s the expected length of the longest run of consecutive heads or tails?</p>
<p><em>Taken from Tijms, Henk. Probability: A Lively Introduction. Cambridge University Press, 2017.</em></p>
</div>
</div>
<div id="homework" class="section level1">
<h1>Homework</h1>
<ul>
<li>Score in canvas</li>
<li>Feedback in github</li>
<li>Graded by Thursday</li>
</ul>
</div>
<div id="computation-in-statistics-task" class="section level1">
<h1>Computation in Statistics task</h1>
<p>Two comments:</p>
<ol style="list-style-type: decimal">
<li><p>Make sure you preview your .md documents on github. A well formatted document will make it easy to identify your answers (as opposed to the questions).</p></li>
<li><p><strong>Citations</strong>: I don’t care which style you use (MLA, APA, etc) but it must include title, authors, year, journal, issue etc. Easiest way to get one is look for a link on the article page for Export Citation.</p></li>
</ol>
<div id="my-take" class="section level2">
<h2>My take</h2>
<p>Out of 30 submissions, 7 unique articles that had some substantial computation, in three broad categories:</p>
<ul>
<li>Simulation of a complex (or simple) process, and summaries of the resulting distributions
<ul>
<li>F. Din-Houn Lau and Axel Gandy [2016] Enhancing football league tables. <a href="https://rss.onlinelibrary.wiley.com/doi/epdf/10.1111/j.1740-9713.2016.00956.x" class="uri">https://rss.onlinelibrary.wiley.com/doi/epdf/10.1111/j.1740-9713.2016.00956.x</a></li>
<li>A variation of the birthday problem - a reader responds, Friedman, E.M., <a href="https://www.significancemagazine.com/science/422-a-variation-of-the-birthday-problem-a-reader-responds" class="uri">https://www.significancemagazine.com/science/422-a-variation-of-the-birthday-problem-a-reader-responds</a></li>
<li>How our election forecast model at the Polling Observatory works, Robert Ford, Will Jennings, Mark Pickup &amp; Christopher Wlezien <a href="https://www.significancemagazine.com/politics/272-how-our-model-at-the-polling-observatory-works" class="uri">https://www.significancemagazine.com/politics/272-how-our-model-at-the-polling-observatory-works</a></li>
</ul></li>
<li>A analysis of a single dataset using a computationally intensive tool
<ul>
<li>Meyer, Renate, and Nelson Christensen. “Gravitational waves: A statistical autopsy of a black hole merger.” Significance 13.2 (2016): 20-25. <a href="https://doi.org/10.1111/j.1740-9713.2016.00896.x" class="uri">https://doi.org/10.1111/j.1740-9713.2016.00896.x</a></li>
<li>Paulden, T. (2016), Smashing the racket. Significance, 13: 16-21. <a href="doi:10.1111/j.1740-9713.2016.00914.x" class="uri">doi:10.1111/j.1740-9713.2016.00914.x</a></li>
</ul></li>
<li>A comparison of many statistical methods over simulated datasets
<ul>
<li>Citation: Eklund, A. and Nichols, T. (2017), How open science revealed false positives in brain imaging. Significance, 14: 30-33. <a href="doi:10.1111/j.1740-9713.2017.01000.x" class="uri">doi:10.1111/j.1740-9713.2017.01000.x</a></li>
</ul></li>
</ul>
<p>Articles providing enough links to code and data to reproduce the analysis were rare.</p>
</div>
<div id="project" class="section level2">
<h2>Project</h2>
<p>Proposals will be due as part of homework #3. (More details on what a proposal looks like then).</p>
<p>Start thinking about what you’d like to work on.</p>
<p>It probably will fit into one of the three categories above, or additionally you might aim to implement a statistical algorithm of interest.</p>
<p>It should stretch your current abilities.</p>
<p>I would expect over the quarter you put in ~ 40 hours. (planning, implementation (coding), making the implementation nice, documentation, communication).</p>
<p>I’m here to help, with some indication of your interests.</p>
</div>
</div>
<div id="simulation" class="section level1">
<h1>Simulation</h1>
<div id="one-pretty-flexible-approach" class="section level2">
<h2>One pretty flexible approach</h2>
<ol style="list-style-type: decimal">
<li>Simulate many examples (<code>rerun()</code>)</li>
<li>Calculate something on each example (<code>map()</code>, <code>map_dbl()</code>)</li>
<li>Explore the many calculated things (<code># depends on goal</code>)</li>
</ol>
</div>
<div id="the-challenge-from-last-time" class="section level2">
<h2>The challenge from last time</h2>
<p>A random sequence of H’s and T’s is generated by tossing a fair coin <span class="math inline">\(n = 20\)</span> times. What’s the expected length of the longest run of consecutive heads or tails?</p>
<p><em>Taken from Tijms, Henk. Probability: A Lively Introduction. Cambridge University Press, 2017.</em></p>
<pre class="r"><code># A single simulated example 1 = H, 0 = T
one_sequence &lt;- rbinom(20, size = 1, prob = 0.5)</code></pre>
<pre class="r"><code># Longest run?
max(rle(one_sequence)$lengths)</code></pre>
<pre><code>## [1] 5</code></pre>
<p>All together…</p>
<pre class="r"><code>num_sims &lt;- 1000
many_sequences &lt;- rerun(num_sims, 
  rbinom(20, size = 1, prob = 0.5))
longest_runs &lt;- map_dbl(many_sequences, 
  ~ max(rle(.)$lengths))

# Finally...
mean(longest_runs)</code></pre>
<pre><code>## [1] 4.639</code></pre>
</div>
<div id="ways-things-get-more-complicated" class="section level2">
<h2>Ways things get more complicated</h2>
<ol style="list-style-type: decimal">
<li>The thing you are simulating is complicated.</li>
<li>The thing you are calculating is complicated.</li>
<li>The thing you are simulating or calculating depends on some parameters and you want to explore how they affect the result.</li>
</ol>
<p>Solve 1. and 2. by writing functions, 3. with further iteration.</p>
</div>
<div id="functions---your-turn" class="section level2">
<h2>Functions - Your Turn</h2>
<p>(4 min)</p>
<ul>
<li><p>What are the three key steps to writing a function? <strong>Assuming you already have a working snippet of code</strong></p>
<ol style="list-style-type: decimal">
<li>Choose a good name - really important!!</li>
<li>Define the arguments</li>
<li>Write the body</li>
</ol></li>
<li><p>Turning the following snippet into a function:</p></li>
</ul>
<pre class="r"><code>x &lt;- 1:10

# sd_over_mean
# ratio_function
# cv

# a minimal version
coefficient_of_variation &lt;- function(x){
  sd(x, na.rm = TRUE) / mean(x, na.rm = TRUE)
}

# our final version
coefficient_of_variation &lt;- function(x, na.rm = FALSE, ...){
  sd(x, na.rm = na.rm) / mean(x, na.rm = na.rm, ...)
}

x &lt;- runif(10)
coefficient_of_variation(x = x)</code></pre>
<pre><code>## [1] 0.4623089</code></pre>
<pre class="r"><code>coefficient_of_variation(x = x, trim = 0.25)</code></pre>
<pre><code>## [1] 0.4564815</code></pre>
</div>
<div id="exponential-inverse-transform" class="section level2">
<h2>Exponential Inverse Transform</h2>
<p>From last week: to generate a sample from Exp(<span class="math inline">\(\lambda\)</span>)</p>
<pre class="r"><code>u &lt;- runif(1)
lambda &lt;- 5
(x &lt;- -1 / lambda * log(1 - u))</code></pre>
<pre><code>## [1] 0.1018719</code></pre>
<p><strong>Your turn</strong> Turn this into a function. What should the arguments be?</p>
<pre class="r"><code>u &lt;- runif(1)
lambda &lt;- 5
(x &lt;- -1 / lambda * log(1 - u))</code></pre>
<pre><code>## [1] 0.02019427</code></pre>
<pre class="r"><code>sample_exp &lt;- function(n, lambda){
  u &lt;- runif(n)
  -1 / lambda * log(1 - u)
}

sample_exp(10, lambda = 5)</code></pre>
<pre><code>##  [1] 0.1519967204 0.1512896536 0.0042851299 0.1562532665 0.2497672581
##  [6] 0.1366965437 0.2555457133 0.0002328799 0.1706922360 0.0479803846</code></pre>
<p><strong>Back at 9:03</strong></p>
</div>
<div id="inverse-transform" class="section level2">
<h2>Inverse Transform</h2>
<p>What if we wanted this to work for any inverse CDF function?</p>
<pre class="r"><code>exp_icdf &lt;- function(u, lambda) {-1 / lambda * log(1 - u)}

u &lt;- runif(1)
exp_icdf(u, lambda = 5)</code></pre>
<pre><code>## [1] 0.1628068</code></pre>
<pre class="r"><code>sample_inverse_cdf &lt;- function(n, inv_cdf, ...){
  u &lt;- runif(n)
  inv_cdf(u, ...)
}
sample_inverse_cdf(20, exp_icdf, lambda = 5)</code></pre>
<pre><code>##  [1] 0.053899622 0.025974188 0.165090472 0.711054570 0.313451911
##  [6] 0.257789633 0.103208275 0.184061036 0.175007737 1.020635893
## [11] 0.122751554 0.280594812 0.412539486 0.016316951 0.012855245
## [16] 0.046939276 0.071643537 0.157593954 0.007222465 0.207302211</code></pre>
<p><strong>Your Turn</strong> Try it to simulate 100 values from a Normal(0, 1). Hint: you can use the built-in inverse CDF function <code>qnorm()</code>.</p>
<pre class="r"><code>qnorm(0.5) # can use the built in quantile function </code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code>x &lt;- sample_inverse_cdf(100, qnorm) 
hist(x) # Looks good</code></pre>
<p><img src="04-functions-sim-size_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<pre class="r"><code># The `...` allow us to pass in other parameters to our inverse 
# CDF function
x &lt;- sample_inverse_cdf(10000, qnorm, mean = 5) 
hist(x) # Now centered at 5</code></pre>
<p><img src="04-functions-sim-size_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
<div id="takeaways" class="section level2">
<h2>Takeaways</h2>
<ul>
<li>Use functions to remove duplication and wrap-up important pieces of code</li>
<li>You can pass functions into other functions in R (super useful technique we will see over and over again)</li>
</ul>
<p>(Pick up here on Thursday)</p>
</div>
</div>
<div id="how-many-simulations-do-we-need" class="section level1">
<h1>How many simulations do we need?</h1>
<p>First a little notation…</p>
<p><span class="math inline">\(\pmb{X}\)</span> is a random variable (possibly vector valued) with some cdf <span class="math inline">\(F_X\)</span></p>
<p>In Monte Carlo simulation, we often want to estimate <span class="math display">\[
  \theta = \text{E}\left( h(\pmb{X})\right)
\]</span></p>
<p>We do this by:</p>
<ol style="list-style-type: decimal">
<li><p>Sampling <span class="math inline">\(\pmb{X}_1, \ldots, \pmb{X}_n\)</span> i.i.d from distribution <span class="math inline">\(F_X\)</span>.</p></li>
<li><p>Calculating <span class="math inline">\(h(\pmb{X}_1), \ldots, h(\pmb{X}_n)\)</span>.</p></li>
<li><p>Finding the sample mean of the <span class="math inline">\(h(\pmb{X}_i)\)</span>, i.e. <span class="math display">\[
\hat{\theta} = \frac{1}{n}\sum_{i = 1}^n h(\pmb{X}_i)
\]</span></p></li>
</ol>
<p>This mirrors exactly our current approach:</p>
<ol style="list-style-type: decimal">
<li><code>samples &lt;- rerun(n, ~ sampling_function(.))</code></li>
<li><code>calculated_values &lt;- map_dbl(samples, ~ calulating_function(.))</code></li>
<li><code>mean(calculated_values)</code></li>
</ol>
<p>The WLLN (Weak Law of Large Numbers) provides us a guarantee this will work.</p>
<div id="how-big-a-simulation-should-we-run" class="section level2">
<h2>How big a simulation should we run?</h2>
<p>How accurately do we want to estimate <span class="math inline">\(\theta\)</span>?</p>
<p><strong>Your Turn</strong> Can you get a confidence interval on the estimate of the expected length of the longest run from our earlier example?</p>
<pre class="r"><code>theta_hat &lt;- mean(longest_runs)

# 95%
theta_hat + c(-1, 1) * 1.96 * (sd(longest_runs)/sqrt(num_sims))</code></pre>
<pre><code>## [1] 4.542639 4.735361</code></pre>
</div>
<div id="clt" class="section level2">
<h2>CLT</h2>
<p>Let <span class="math inline">\(Y = h(X)\)</span>, <span class="math inline">\(\mu = E(Y)\)</span> and <span class="math inline">\(\overline{Y} = \sum_{i = 1}^n h(X_i)\)</span>.</p>
<p>Then <span class="math display">\[
\text{Var}(\hat{\theta}) = \text{Var}(\overline{Y}) \dot \sim \,  N\left(\mu, \frac{\text{Var}(Y)}{n}\right)
\]</span> for large <span class="math inline">\(n\)</span> by the Central Limit Theorem.</p>
<p>We don’t know <span class="math inline">\(\text{Var}(Y)\)</span>, but we can estimate it using our simulated <span class="math inline">\(Y_i\)</span>.</p>
<p>Leads to the usual 95% CI formula: <span class="math display">\[
\overline{Y} \pm 1.96 \frac{s}{\sqrt{n}}
\]</span> where <span class="math inline">\(s\)</span> is the sample standard deviation of the <span class="math inline">\(Y_i\)</span>, and <span class="math inline">\(n\)</span> the number of simulations.</p>
</div>
<div id="a-special-case-binary-outcomes" class="section level2">
<h2>A special case: binary outcomes</h2>
<p>New question: What’s the probability of a run greater than 10?</p>
<p>Want to know: <span class="math display">\[
p = \text{P}(h(\pmb{X}) = 1)
\]</span> where <span class="math display">\[
h(\pmb{X}) = 
\begin{cases}
1, \, \text{when longest run in sequence } \pmb{X} \text{ is greater than 10}, \\
0, \, \text{otherwise}
\end{cases}
\]</span> same as asking for <span class="math inline">\(p =\theta = \text{E}\left( h(\pmb{X})\right)\)</span>.</p>
<p>We already have enough to get this new function of our samples:</p>
<pre class="r"><code>longest_runs &gt; 10</code></pre>
<p>Estimate <span class="math inline">\(\theta\)</span> with:</p>
<pre class="r"><code>p_hat &lt;- mean(longest_runs &gt; 10)</code></pre>
<p>What’s <span class="math inline">\(Var(\hat{\theta})\)</span> in this setting?</p>
<p>Use result from Bernoulli random variables <span class="math display">\[
Var(\hat{p}) = p(1 - p)
\]</span></p>
<p>Leads to a CI based only on the estimated probability:</p>
<pre class="r"><code>p_hat + c(-1, 1) * 1.96 * (sqrt(p_hat*(1-p_hat))/sqrt(num_sims))</code></pre>
<pre><code>## [1] 0.0006282772 0.0093717228</code></pre>
<p>The mean approach still works, but will give slightly different values:</p>
<pre class="r"><code>p_hat + c(-1, 1) * 1.96 * (sd(longest_runs &gt; 10)/sqrt(num_sims))</code></pre>
<pre><code>## [1] 0.0006260897 0.0093739103</code></pre>
</div>
<div id="how-big-a-simulation" class="section level2">
<h2>How big a simulation?</h2>
<ul>
<li>Base it on a desired width of CI (you might need a pilot simulation to estimate the variance first)</li>
<li>Simulate again and decide if the next estimate is “close enough” to the first (if not, increase the simulation size)</li>
</ul>
</div>
<div id="next-time" class="section level2">
<h2>Next time</h2>
<p>Simulating in clever ways to reduce the variance of the estimate, <span class="math inline">\(\text{Var}(\hat{\theta})\)</span>.</p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
